{% extends "base-dash.html" %}
{% load static %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
        font-family: 'Inter', sans-serif;
    }

    .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .card-modern {
        backdrop-filter: blur(20px);
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 1rem;
    }

    .card-modern:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .stat-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.8) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 1rem;
    }

    .stat-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    .floating-animation {
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }

    .pulse-dot {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .glass-effect {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .text-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .progress-modern {
        background: rgba(255, 255, 255, 0.2);
        height: 8px;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar-modern {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .sidebar-modern {
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
    }

    .form-select, .form-control {
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
    }

    .btn-outline-secondary {
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
    }

    .badge-modern {
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-weight: 500;
    }
</style>

<!-- Header avec gradient moderne -->
<div class="gradient-bg text-white container-fluid py-4">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-chart-line text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold">Tableau de Bord</h1>
                    <p class="text-blue-100">Aperçu global des performances</p>
                </div>
            </div>
            <div class="glass-effect rounded-xl px-4 py-2">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-calendar-alt"></i>
                    <select class="bg-transparent text-white border-none outline-none period-select">
                        <option value="month">Ce mois</option>
                        <option value="trimestre">Ce trimestre</option>
                        <option value="year">Cette année</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
    <br>
    <br>
    <br>

<div class="">
    <!-- Cartes de statistiques principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Élèves -->
        <div class="stat-card rounded-2xl p-6 shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Total Élèves</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ total_eleves }}</p>
                    <div class="flex items-center mt-2">
                        <span class="text-green-500 text-sm font-medium" id="evolution_recettes">+12%</span>
                        <span class="text-gray-500 text-sm ml-1">vs mois dernier</span>
                    </div>
                </div>
                <div class="stat-icon w-14 h-14 rounded-2xl flex items-center justify-center text-white">
                    <i class="fas fa-users text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Total Dépenses -->
        <div class="stat-card rounded-2xl p-6 shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Total Dépenses</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ total_depenses }} FC</p>
                    <div class="flex items-center mt-2">
                        <span class="text-red-500 text-sm font-medium">-2%</span>
                        <span class="text-gray-500 text-sm ml-1">vs mois dernier</span>
                    </div>
                </div>
                <div class="w-14 h-14 bg-red-500 rounded-2xl flex items-center justify-center text-white">
                    <i class="fas fa-credit-card text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Chiffre d'Affaires -->
        <div class="stat-card rounded-2xl p-6 shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Chiffre d'Affaires</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ chiffre_affaires }} FC</p>
                    <div class="flex items-center mt-2">
                        <span class="text-green-500 text-sm font-medium">+5%</span>
                        <span class="text-gray-500 text-sm ml-1">vs mois dernier</span>
                    </div>
                </div>
                <div class="w-14 h-14 bg-green-500 rounded-2xl flex items-center justify-center text-white">
                    <i class="fas fa-dollar-sign text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Élèves en Retard -->
        <div class="stat-card rounded-2xl p-6 shadow-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wide">Élèves en Retard</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ taux_retard|floatformat:2 }}%</p>
                    <div class="flex items-center mt-2">
                        <span class="text-yellow-500 text-sm font-medium">+1%</span>
                        <span class="text-gray-500 text-sm ml-1">de retard</span>
                    </div>
                </div>
                <div class="w-14 h-14 bg-yellow-500 rounded-2xl flex items-center justify-center text-white">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Première ligne de graphiques -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Répartition par Mois -->
        <div class="card-modern rounded-2xl p-6 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Répartition par Mois</h3>
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">12 Mois</span>
            </div>
            <div class="space-y-4">
                {% for mois in stats.par_mois %}
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <div class="flex items-center space-x-3">
                        <span class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white text-sm font-bold">{{ forloop.counter }}</span>
                        <span class="font-medium text-gray-700">{{ mois.mois }}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-lg font-bold text-gray-800">{{ mois.total }} FC</span>
                        <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs ml-2">{{ mois.nombre_eleves }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Comparatifs -->
        <div class="card-modern rounded-2xl p-6 shadow-xl">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Comparatifs</h3>
            <div class="space-y-6">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600 text-sm">Période Actuelle</span>
                        <span class="font-bold text-green-600" id="current_period_value">0.00 FC</span>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-600 text-sm">Période Précédente</span>
                        <span class="font-bold text-gray-500" id="previous_period_value">0.00 FC</span>
                    </div>
                    <div class="progress-modern">
                        <div class="progress-bar-modern" id="period_progress" style="width: 75%"></div>
                    </div>
                    <p class="text-green-600 text-sm mt-2 text-right" id="evolution_recettes_2">
                        Chargement...
                    </p>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600 text-sm">Année Scolaire Actuelle</span>
                        <span class="font-bold text-blue-600" id="current_year_value">0.00 FC</span>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-600 text-sm">Année Scolaire Précédente</span>
                        <span class="font-bold text-gray-500" id="previous_year_value">0.00 FC</span>
                    </div>
                    <div class="progress-modern">
                        <div class="progress-bar-modern" id="year_progress" style="width: 85%"></div>
                    </div>
                    <p class="text-blue-600 text-sm mt-2 text-right" id="evolution_annee">
                        Aucune donnée
                    </p>
                </div>
            </div>
        </div>

        <!-- Top Sections par Recettes -->
        <div class="card-modern rounded-2xl p-6 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Top Sections</h3>
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">Top 5</span>
            </div>
            <div class="chart-container">
                <canvas id="topSectionsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Deuxième ligne de graphiques -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-8">
        <!-- Top Frais -->
        <div class="lg:col-span-2 card-modern rounded-2xl p-6 shadow-xl">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Top 5 Frais</h3>
            <div class="chart-container">
                <canvas id="topFraisChart"></canvas>
            </div>
        </div>

        <!-- Évolution des Paiements -->
        <div class="lg:col-span-3 card-modern rounded-2xl p-6 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Évolution des Paiements</h3>
                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">12 mois</span>
            </div>
            <div class="chart-container">
                <canvas id="paiementsMensuelsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Troisième ligne -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-8">
        <!-- Répartition Élèves -->
        <div class="lg:col-span-2 card-modern rounded-2xl p-6 shadow-xl">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Répartition par Section</h3>
            <div class="chart-container">
                <canvas id="elevesParSectionChart"></canvas>
            </div>
        </div>

        <!-- Top Classes par Recettes -->
        <div class="lg:col-span-3 card-modern rounded-2xl p-6 shadow-xl">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Top des Classes par Recettes</h3>
            <div class="chart-container">
                <canvas id="topClassesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Filtrage Section -->
    <div class="card-modern rounded-2xl p-6 shadow-xl mb-8">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800">Filtrage Avancé</h3>
            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">{{ eleves_recap|length }} élève(s)</span>
        </div>

        <form method="get" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.section.label }}</label>
                    {{ form.section }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.option.label }}</label>
                    {{ form.option }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.classe.label }}</label>
                    {{ form.classe }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.frais.label }}</label>
                    {{ form.frais }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.mois.label }}</label>
                    {{ form.mois }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.matricule.label }}</label>
                    {{ form.matricule }}
                </div>
            </div>

            <div class="flex justify-center space-x-4">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-filter"></i>
                    <span>Appliquer</span>
                </button>
                <a href="{% url 'dashboard' %}" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-undo"></i>
                    <span>Réinitialiser</span>
                </a>
            </div>
        </form>
    </div>

    <!-- Footer -->
    <footer class="text-center py-8">
        <div class="glass-effect rounded-2xl p-6 max-w-2xl mx-auto">
            <div class="flex items-center justify-center space-x-2 mb-2">
                <span class="text-gray-600">© <script>document.write(new Date().getFullYear())</script>, conçu avec</span>
                <i class="fas fa-heart text-red-500 pulse-dot"></i>
                <span class="text-gray-600">par</span>
                <a href="moninvitation.org/guest/jonaskasongo.php" class="text-gradient font-semibold hover:underline">JONAS KASONGO</a>
            </div>
            <div class="text-gray-500 text-sm">
                <span>Version 2.0.0</span>
            </div>
        </div>
    </footer>
</div>

<!-- Chart Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static '/js/dashboard.js' %}"></script>
<script>
    // Configuration générale des graphiques
    Chart.defaults.font.family = 'Inter';
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#6B7280';

    // Graphique Évolution des paiements mensuels
    var ctx1 = document.getElementById("paiementsMensuelsChart").getContext("2d");
    var gradientStroke1 = ctx1.createLinearGradient(0, 0, 0, 300);
    gradientStroke1.addColorStop(0, 'rgba(103, 126, 234, 0.4)');
    gradientStroke1.addColorStop(1, 'rgba(103, 126, 234, 0.05)');

    new Chart(ctx1, {
        type: "line",
        data: {
            labels: [{% for paiement in paiements_mensuels %}'{{ paiement.mois_calcule|date:"F Y" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: "Montant Payé",
                tension: 0.4,
                borderColor: 'rgba(103, 126, 234, 1)',
                backgroundColor: gradientStroke1,
                borderWidth: 3,
                fill: true,
                data: [{% for paiement in paiements_mensuels %}{{ paiement.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                pointBackgroundColor: 'rgba(103, 126, 234, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index',
            },
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(107, 114, 128, 0.1)' },
                    ticks: {
                        callback: function(value) {
                            return value + ' FC';
                        }
                    }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // Graphique Répartition des élèves par section
    var ctx2 = document.getElementById("elevesParSectionChart").getContext("2d");
    new Chart(ctx2, {
        type: "doughnut",
        data: {
            labels: [{% for section in eleves_par_section %}'{{ section.classe__section__nom }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for section in eleves_par_section %}{{ section.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [
                    'rgba(103, 126, 234, 0.8)',
                    'rgba(45, 206, 137, 0.8)',
                    'rgba(251, 99, 64, 0.8)',
                    'rgba(255, 193, 7, 0.8)'
                ],
                borderColor: [
                    'rgba(103, 126, 234, 1)',
                    'rgba(45, 206, 137, 1)',
                    'rgba(251, 99, 64, 1)',
                    'rgba(255, 193, 7, 1)'
                ],
                borderWidth: 0,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                }
            }
        }
    });

    // Récupérer les données depuis Django
    const topFraisData = {{ top_frais|safe }};

    // Graphique Top Frais
    if (topFraisData && topFraisData.length > 0) {
        const labels = topFraisData.map(item => item.nom);
        const dataValues = topFraisData.map(item => parseFloat(item.total));

        const topFraisCtx = document.getElementById('topFraisChart').getContext('2d');
        new Chart(topFraisCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Montant Total (FC)',
                    data: dataValues,
                    backgroundColor: [
                        'rgba(103, 126, 234, 0.8)',
                        'rgba(45, 206, 137, 0.8)',
                        'rgba(251, 99, 64, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(156, 39, 176, 0.8)'
                    ],
                    borderColor: [
                        'rgba(103, 126, 234, 1)',
                        'rgba(45, 206, 137, 1)',
                        'rgba(251, 99, 64, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(156, 39, 176, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(107, 114, 128, 0.1)' },
                        ticks: {
                            callback: function(value) {
                                return value + ' FC';
                            }
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    } else {
        // Si aucune donnée, afficher un message
        document.getElementById('topFraisChart').getContext('2d').canvas.parentNode.innerHTML =
            '<div class="text-center py-8 text-gray-500"><i class="fas fa-exclamation-circle mr-2"></i>Aucun frais trouvé</div>';
    }

    document.addEventListener("DOMContentLoaded", function () {
        const sectionSelect = document.getElementById("id_section");
        const optionSelect = document.getElementById("id_option");
        const classeSelect = document.getElementById("id_classe");
        const fraisSelect = document.getElementById("id_frais");

        // Fonction pour charger les options selon la section
        function updateOptions() {
            const sectionId = sectionSelect.value;
            if (!sectionId) return;

            fetch(`/api/get-options/${sectionId}/`)
                .then(res => res.json())
                .then(data => {
                    // Vider les champs précédents
                    optionSelect.innerHTML = '<option value="">-- Choisir --</option>';
                    classeSelect.innerHTML = '<option value="">-- Choisir --</option>';

                    // Activer/désactiver l'option selon la section
                    if (["Humanités", "ITM"].includes(sectionSelect.options[sectionSelect.selectedIndex]?.text)) {
                        data.options.forEach(opt => {
                            const option = new Option(opt.nom, opt.id);
                            optionSelect.add(option);
                        });
                        optionSelect.disabled = false;
                    } else {
                        optionSelect.disabled = true;
                    }

                    // Charger les classes en fonction de la section
                    updateClasses();
                })
                .catch(err => console.error("Erreur lors du chargement des options:", err));
        }

        // Fonction pour charger les classes selon la section et l'option
        function updateClasses() {
            const sectionId = sectionSelect.value;
            const optionId = optionSelect.value || null;

            let url = `/api/get-classes/${sectionId}/`;
            if (optionId && ["Humanités", "ITM"].includes(sectionSelect.options[sectionSelect.selectedIndex]?.text)) {
                url += `${optionId}/`;
            }

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    classeSelect.innerHTML = '<option value="">-- Choisir --</option>';
                    data.classes.forEach(classe => {
                        const option = new Option(classe.nom, classe.id);
                        classeSelect.add(option);
                    });
                })
                .catch(err => console.error("Erreur lors du chargement des classes:", err));
        }

        // Fonction pour charger les frais selon la classe (utilisation de l'API existante)
        function updateFrais(classeId) {
            fetch(`/api/get-frais/${classeId}/`)
                .then(res => res.json())
                .then(data => {
                    fraisSelect.innerHTML = '<option value="">-- Choisir --</option>';

                    // Vérifier si la réponse contient un message (ex: pas de frais)
                    if (Array.isArray(data)) {
                        data.forEach(frais => {
                            const option = new Option(`${frais.nom} (${frais.type_frais})`, frais.id);
                            fraisSelect.add(option);
                        });
                    } else if (data.message) {
                        const option = new Option(data.message, "");
                        option.disabled = true;
                        fraisSelect.add(option);
                    }
                })
                .catch(err => console.error("Erreur lors du chargement des frais:", err));
        }

        // Gestion des événements
        sectionSelect.addEventListener("change", function () {
            updateOptions();
        });

        optionSelect.addEventListener("change", function () {
            updateClasses();
        });

        classeSelect.addEventListener("change", function () {
            if (classeSelect.value) {
                updateFrais(classeSelect.value);
            }
        });

        // Chargement initial si une section est déjà sélectionnée
        if (sectionSelect.value) {
            updateOptions();
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const periodSelect = document.querySelector(".period-select");
        const evolutionSpan = document.getElementById("evolution_recettes_2");
        const evolutionAnnee = document.getElementById("evolution_annee");

        function updateDashboardStats(period) {
            fetch(`/api/dashboard-stats/?period=${period}`)
                .then(res => res.json())
                .then(data => {
                    // Update period values
                    document.getElementById("current_period_value").textContent = `${data.current_total.toFixed(2)} FC`;
                    document.getElementById("previous_period_value").textContent = `${data.previous_total.toFixed(2)} FC`;

                    // Update year values
                    document.getElementById("current_year_value").textContent = `${data.current_year_total.toFixed(2)} FC`;
                    document.getElementById("previous_year_value").textContent = `${data.previous_year_total.toFixed(2)} FC`;

                    // Update progress bars
                    const periodProgress = Math.min(100, Math.abs(data.evolution_percentage) * 5);
                    const yearProgress = Math.min(100, Math.abs(data.yearly_evolution) * 3);

                    document.getElementById("period_progress").style.width = `${periodProgress}%`;
                    document.getElementById("year_progress").style.width = `${yearProgress}%`;

                    // Update evolution text
                    const evolutionText = data.evolution_percentage >= 0
                        ? `+${data.evolution_percentage.toFixed(2)}% vs période précédente`
                        : `${data.evolution_percentage.toFixed(2)}% vs période précédente`;
                    evolutionSpan.textContent = evolutionText;
                    evolutionSpan.className = data.evolution_percentage >= 0
                        ? "text-green-600 text-sm mt-2 text-right"
                        : "text-red-600 text-sm mt-2 text-right";

                    // Update yearly evolution text
                    const yearlyEvolutionText = data.yearly_evolution >= 0
                        ? `+${data.yearly_evolution.toFixed(2)}% de croissance`
                        : `${data.yearly_evolution.toFixed(2)}% de décroissance`;
                    evolutionAnnee.textContent = yearlyEvolutionText;
                    evolutionAnnee.className = data.yearly_evolution >= 0
                        ? "text-blue-600 text-sm mt-2 text-right"
                        : "text-red-600 text-sm mt-2 text-right";
                })
                .catch(err => {
                    console.error("Erreur lors du chargement des stats:", err);
                    evolutionSpan.textContent = "Erreur de chargement";
                    evolutionSpan.className = "text-red-600 text-sm mt-2 text-right";
                });
        }

        // Gestion des changements de période
        periodSelect.addEventListener("change", function () {
            const period = this.value;
            updateDashboardStats(period);
        });

        // Chargement initial avec "ce mois"
        updateDashboardStats("month");
    });

    // Graphique Top Classes
    let topClassesChart = null;

    async function loadTopClassesData() {
        const apiUrl = '/api/dashboard-stats/?top_class';

        try {
            const response = await fetch(apiUrl);

            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }

            const data = await response.json();

            if (!data || !data.top_classes) {
                throw new Error('Structure de données invalide');
            }

            updateTopClassesChart(data.top_classes);

        } catch (error) {
            console.error('Erreur lors du chargement:', error);
            updateTopClassesChart([]);
        }
    }

    function updateTopClassesChart(topClassesData) {
        const ctx = document.getElementById('topClassesChart');
        if (!ctx) {
            console.error("Canvas non trouvé");
            return;
        }

        const labels = topClassesData.map(item => item.eleve__classe__nom || 'Classe Inconnue');
        const dataValues = topClassesData.map(item => Number(item.total_recettes) || 0);

        if (topClassesChart) {
            topClassesChart.destroy();
        }

        topClassesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Recettes (FC)',
                    data: dataValues,
                    backgroundColor: 'rgba(45, 206, 137, 0.8)',
                    borderColor: 'rgba(45, 206, 137, 1)',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: 'rgba(107, 114, 128, 0.1)' },
                        ticks: {
                            callback: function(value) {
                                return value + ' FC';
                            }
                        }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Graphique Top Sections
    let topSectionsChart = null;

    async function loadTopSectionsData() {
        const apiUrl = '/api/dashboard-stats/?top_section';

        try {
            const response = await fetch(apiUrl);

            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }

            const data = await response.json();

            if (!data || !data.top_sections) {
                throw new Error('Structure de données invalide');
            }

            updateTopSectionsChart(data.top_sections);

        } catch (error) {
            console.error('Erreur lors du chargement des sections:', error);
            updateTopSectionsChart([]);
        }
    }

    function updateTopSectionsChart(topSectionsData) {
        const ctx = document.getElementById('topSectionsChart');
        if (!ctx) {
            console.error("Canvas non trouvé pour les sections");
            return;
        }

        const labels = topSectionsData.map(item => item.eleve__classe__section__nom || 'Section Inconnue');
        const dataValues = topSectionsData.map(item => Number(item.total_recettes) || 0);

        if (topSectionsChart) {
            topSectionsChart.destroy();
        }

        topSectionsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Recettes (FC)',
                    data: dataValues,
                    backgroundColor: [
                        'rgba(103, 126, 234, 0.8)',
                        'rgba(45, 206, 137, 0.8)',
                        'rgba(251, 99, 64, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(156, 39, 176, 0.8)'
                    ],
                    borderColor: [
                        'rgba(103, 126, 234, 1)',
                        'rgba(45, 206, 137, 1)',
                        'rgba(251, 99, 64, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(156, 39, 176, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(107, 114, 128, 0.1)' },
                        ticks: {
                            callback: function(value) {
                                return value + ' FC';
                            }
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Charger les données au démarrage
    document.addEventListener('DOMContentLoaded', function() {
        loadTopClassesData();
        loadTopSectionsData();

        // Animation des cartes statistiques
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.6s ease';
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100);
            }, index * 100);
        });

        // Effet de hover sur les graphiques
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
            container.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.02)';
                this.style.transition = 'transform 0.3s ease';
            });

            container.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        });
    });
</script>
{% endblock %}
