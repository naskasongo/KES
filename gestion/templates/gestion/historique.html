<!-- templates/gestion/historique.html -->
{% extends "base.html" %}
{% load humanize %}

{% block title %}Historique des Activit√©s - Wantashi{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">


                <!-- Filtres -->
                <!-- Formulaire de filtre -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0 text-white">üîç Filtres</h5>
                    </div>
                    <div class="card-body">
                        <form method="get" class="form-inline">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <select name="modele" class="form-control w-100">
                                        <option value="">Tous les mod√®les</option>
                                        {% for modele in modeles_disponibles %}
                                            <option value="{{ modele }}" {% if modele == current_modele %}selected{% endif %}>
                                                {{ modele }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" name="utilisateur" class="form-control w-100"
                                           placeholder="Filtrer par utilisateur"
                                           value="{{ current_utilisateur }}">
                                </div>
                                <div class="col-md-3">
                                    <select name="action" class="form-control w-100">
                                        <option value="">Toutes les actions</option>
                                        <option value="Cr√©ation" {% if current_action == 'Cr√©ation' %}selected{% endif %}>Cr√©ation</option>
                                        <option value="Modification" {% if current_action == 'Modification' %}selected{% endif %}>Modification</option>
                                        <option value="Suppression" {% if current_action == 'Suppression' %}selected{% endif %}>Suppression</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" name="date_debut" class="form-control w-100"
                                           value="{{ current_date_debut }}" placeholder="Date d√©but">
                                </div>
                                <div class="col-md-3">
                                    <input type="date" name="date_fin" class="form-control w-100"
                                           value="{{ current_date_fin }}" placeholder="Date fin">
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-primary w-100">Filtrer</button>
                                    <a href="{% url 'historique' %}" class="btn btn-secondary w-100 mt-2">R√©initialiser</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                                <!-- Statistiques -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0 text-white">üìä Statistiques</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <p class="text-muted">Total d'actions</p>
                                <h4>{{ stats.total_actions }}</h4>
                            </div>

                            <div class="col-md-3">
                                <p class="text-muted">R√©partition par mod√®le</p>
                                <ul class="list-unstyled">
                                    {% for modele, count in stats.par_modele.items %}
                                        <li><strong>{{ modele }}:</strong> {{ count }}</li>
                                    {% endfor %}
                                </ul>
                            </div>

                            <div class="col-md-3">
                                <p class="text-muted">R√©partition par action</p>
                                <ul class="list-unstyled">
                                    {% for action, count in stats.par_action.items %}
                                        <li><strong>{{ action }}:</strong> {{ count }}</li>
                                    {% endfor %}
                                </ul>
                            </div>

                            <div class="col-md-3">
                                <p class="text-muted">√âvolution mensuelle</p>
                                <ul class="list-unstyled">
                                    {% for mois, count in evolution_mensuelle_triee %}
                                        <li><strong>{{ mois }}:</strong> {{ count }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
              <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white">üìú Historique des Op√©rations</h5>
                </div>
                <!-- Tableau -->
                <div class="card-body">
                    {% if historique_list %}
                        <div class="table-responsive">
                            <table id="exportable-table" class="table table-hover align-items-center mb-0">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Utilisateur</th>
                                        <th>Action</th>
                                        <th>Mod√®le</th>
                                        <th>Objet ID</th>
                                        <th>D√©tails</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in historique_list %}
                                        <tr>
                                            <td>{{ item.date_action|date:"d/m/Y H:i" }}</td>

                                        <td>
                                            {% if item.utilisateur_affichage %}
                                                {{ item.utilisateur_affichage|capfirst }}
                                            {% else %}
                                                <span class="text-muted">Inconnu</span>
                                            {% endif %}
                                        </td>


                                            <td>
                                                <span class="badge
                                                    {% if item.action == 'Cr√©ation' %}bg-success
                                                    {% elif item.action == 'Modification' %}bg-warning text-dark
                                                    {% elif item.action == 'Suppression' %}bg-danger
                                                    {% endif %}">
                                                    {{ item.action }}
                                                </span>
                                            </td>
                                            <td>{{ item.modele }}</td>
                                            <td>{{ item.objet_id|default:"‚Äî" }}</td>
                                            <td>{{ item.display_details|truncatechars:80 }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="d-flex justify-content-center mt-4">
                            {% if is_paginated %}
                                <nav aria-label="Page navigation">
                                    <ul class="pagination">
                                        {% if page_obj.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page=1&{{ request.GET.urlencode }}">&laquo; Premi√®re</a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">Pr√©c√©dent</a>
                                            </li>
                                        {% endif %}

                                        {% for num in paginator.page_range %}
                                            {% if num == page_obj.number %}
                                                <li class="page-item active">
                                                    <a class="page-link" href="#">{{ num }}</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode }}">{{ num }}</a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}

                                        {% if page_obj.has_next %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Suivant</a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ paginator.num_pages }}&{{ request.GET.urlencode }}">Derni√®re &raquo;</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="alert alert-info" role="alert">
                            Aucune activit√© enregistr√©e pour le moment.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
